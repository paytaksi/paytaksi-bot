<!doctype html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayTaksi - Sifariş</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1220; color:#fff; }
    #map { height: 58vh; }
    .panel { padding: 12px; }
    .card { background:#111a2e; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; margin-bottom:10px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    input, button { border-radius:12px; border:1px solid rgba(255,255,255,.12); padding:10px; font-size:16px; }
    input { flex:1; background:#0b1220; color:#fff; }
    button { background:#21c17a; border:none; color:#062012; font-weight:700; cursor:pointer; }
    button.secondary { background:#26324f; color:#fff; }
    .muted { color: rgba(255,255,255,.75); font-size: 13px; }
    .big { font-size: 20px; font-weight: 800; }
    .warn { color:#ffcc66; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <div class="card" id="regCard" style="display:none">
      <div class="big">Qeydiyyat</div>
      <div class="muted">Telefon +994 ilə başlamalıdır.</div>
      <div class="row" style="margin-top:10px">
        <input id="firstName" placeholder="Ad" />
        <input id="lastName" placeholder="Soyad" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="phone" placeholder="+994XXXXXXXXX" />
      </div>
      <div class="row" style="margin-top:10px">
        <button onclick="saveProfile()">Yadda saxla</button>
      </div>
    </div>

    <div class="card">
      <div class="big">Marşrut</div>
      <div class="muted">Xəritədə 1-ci toxunuş: <b>Götürmə</b>, 2-ci toxunuş: <b>Gedəcəyiniz yer</b></div>
      <div class="row" style="margin-top:10px">
        <button class="secondary" onclick="useMyLocation()">Mənim yerim</button>
        <button class="secondary" onclick="resetPins()">Sıfırla</button>
      </div>
      <div style="margin-top:10px" class="muted" id="addr"></div>
      <div style="margin-top:10px" class="big" id="price">Qiymət: —</div>
      <div class="muted" id="priceRule">Başlanğıc 3.50 AZN, 3 km-dən sonra hər 1 km = 0.40 AZN</div>
      <div class="row" style="margin-top:10px">
        <button id="orderBtn" onclick="createOrder()" disabled>Sifariş ver</button>
      </div>
      <div class="muted" id="status" style="margin-top:8px"></div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); }

  const apiBase = location.origin;
  let jwtToken = localStorage.getItem('pt_token') || '';
  let me = null;

  async function api(path, opts={}) {
    const headers = opts.headers || {};
    headers['Content-Type'] = headers['Content-Type'] || 'application/json';
    if (jwtToken) headers['Authorization'] = 'Bearer ' + jwtToken;
    if (tg?.initData) headers['x-telegram-init-data'] = tg.initData;
    const res = await fetch(apiBase + path, { ...opts, headers });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data?.error || 'api_error');
    return data;
  }

  async function login() {
    const qp = new URLSearchParams(location.search);
    const bot = qp.get('bot') || 'passenger';
    const headers = { 'x-telegram-init-data': tg?.initData || '' };
    const res = await fetch(apiBase + '/api/auth/webapp?bot=' + bot, { method:'POST', headers });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error || 'login_failed');
    jwtToken = data.token;
    localStorage.setItem('pt_token', jwtToken);
    me = data.user;
  }

  // Map
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  map.setView([40.4093, 49.8671], 12);

  let pickup = null, drop = null;
  let pickupMarker = null, dropMarker = null;
  let routeLine = null;
  let distanceKm = 0;

  function resetPins() {
    pickup = drop = null; distanceKm = 0;
    if (pickupMarker) map.removeLayer(pickupMarker);
    if (dropMarker) map.removeLayer(dropMarker);
    if (routeLine) map.removeLayer(routeLine);
    pickupMarker = dropMarker = routeLine = null;
    document.getElementById('addr').innerText = '';
    document.getElementById('price').innerText = 'Qiymət: —';
    document.getElementById('orderBtn').disabled = true;
  }

  function calcFare(km) {
    const base = 3.50;
    const after3 = Math.max(0, km - 3);
    return Math.round((base + after3 * 0.40) * 100) / 100;
  }

  async function buildRoute() {
    if (!pickup || !drop) return;
    const url = `https://router.project-osrm.org/route/v1/driving/${pickup[1]},${pickup[0]};${drop[1]},${drop[0]}?overview=full&geometries=geojson`;
    const r = await fetch(url);
    const j = await r.json();
    const route = j?.routes?.[0];
    if (!route) return;
    distanceKm = Math.round((route.distance/1000) * 100) / 100;
    const fare = calcFare(distanceKm);

    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { weight: 5 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [20,20] });

    document.getElementById('addr').innerHTML = `Götürmə: <b>${pickup[0].toFixed(5)}, ${pickup[1].toFixed(5)}</b><br>Gedəcəyiniz: <b>${drop[0].toFixed(5)}, ${drop[1].toFixed(5)}</b><br>Məsafə: <b>${distanceKm} km</b>`;
    document.getElementById('price').innerText = `Qiymət: ${fare.toFixed(2)} AZN`;
    document.getElementById('orderBtn').disabled = false;
  }

  map.on('click', async (e) => {
    const p = [e.latlng.lat, e.latlng.lng];
    if (!pickup) {
      pickup = p;
      pickupMarker = L.marker(p).addTo(map).bindPopup('Götürmə').openPopup();
    } else if (!drop) {
      drop = p;
      dropMarker = L.marker(p).addTo(map).bindPopup('Gedəcəyiniz yer').openPopup();
      await buildRoute();
    } else {
      resetPins();
    }
  });

  async function useMyLocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition((pos) => {
      map.setView([pos.coords.latitude, pos.coords.longitude], 16);
    });
  }

  async function ensureReg() {
    const data = await api('/api/profile/me');
    me = data.user;
    const need = !me.phone || !me.firstName;
    document.getElementById('regCard').style.display = need ? 'block' : 'none';
    if (need) {
      document.getElementById('firstName').value = me.firstName || '';
      document.getElementById('lastName').value = me.lastName || '';
      document.getElementById('phone').value = me.phone || '';
    }
  }

  async function saveProfile() {
    try {
      await api('/api/profile/update', {
        method:'POST',
        body: JSON.stringify({
          firstName: document.getElementById('firstName').value,
          lastName: document.getElementById('lastName').value,
          phone: document.getElementById('phone').value
        })
      });
      document.getElementById('regCard').style.display = 'none';
      await ensureReg();
    } catch (e) {
      alert('Xəta: ' + e.message);
    }
  }

  async function createOrder() {
    try {
      document.getElementById('status').innerText = 'Sifariş göndərilir...';
      const ride = await api('/api/rides/create', {
        method:'POST',
        body: JSON.stringify({
          pickupLat: pickup[0], pickupLon: pickup[1], pickupAddr: 'Xəritə nöqtəsi',
          dropLat: drop[0], dropLon: drop[1], dropAddr: 'Xəritə nöqtəsi'
        })
      });
      document.getElementById('status').innerHTML = `✅ Sifariş yaradıldı. ID: <b>#${ride.ride.id}</b>\n\nSürücü axtarılır...`;
    } catch (e) {
      document.getElementById('status').innerText = 'Xəta: ' + e.message;
    }
  }

  (async () => {
    try {
      await login();
      await ensureReg();
    } catch (e) {
      document.getElementById('status').innerHTML = '<span class="warn">Giriş xətası:</span> ' + e.message;
    }
  })();
</script>
</body>
</html>
